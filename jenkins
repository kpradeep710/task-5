pipeline {
    agent any

    tools {
        maven 'maven-3.9' // Make sure this name matches Global Tool Config
    }
    environment {
        JAVA_HOME= '/usr/lib/jvm/java-17-openjdk-amd64'
        SONARQUBE_SERVER = 'sonar-server-10.6'  // Name of the SonarQube server configured in Jenkins
        NEXUS_URL = 'http://localhost:8082/repository/task-snapshot/'
        NEXUS_CREDENTIALS_ID = 'f7958725-8379-4d04-afc0-9a7531c269b6'
    }

    stages {
        stage('Checkout') {
            steps {
                git branch: 'main', url: 'https://github.com/kpradeep710/task-5.git'
            }
        }

        stage('Build on Dynamic Agent') {
            steps {
                // Adjust Maven commands as per project requirements
                sh 'mvn clean install package'
            }
        }

        stage('SonarQube Analysis') {
            steps {
                script {
                    withSonarQubeEnv('sonar-server-10.6') { 
                        sh 'mvn sonar:sonar'
                    }
                }
            }
        }

        stage('Upload to Nexus') {
            steps {
                script {
                    nexusArtifactUploader artifacts: [[artifactId: '01-maven-web-app', 
                                                       classifier: '', 
                                                       file: 'target/01-maven-web-app.war', 
                                                       type: 'war']], 
                                          credentialsId: "${NEXUS_CREDENTIALS_ID}", 
                                          groupId: 'in.ashokit', 
                                          nexusUrl: "${NEXUS_URL}", 
                                          nexusVersion: 'nexus3',
                                          protocol: 'http',
                                          repository: 'task-snapshot', 
                                          version: '3.0-SNAPSHOT'
                }
            }
        }


        stage('Deploy to EC2') {
            steps {
                sshagent(credentials: ['ec2-ssh-credentials']) {
                    // Copy artifact to EC2
                    bat '''
                    scp -o StrictHostKeyChecking=no -i ${PEM_FILE_PATH} target/app.war ${EC2_USER}@${EC2_HOST}:/home/${EC2_USER}/01-maven-web-app.war
                    '''
                    
                    // Run deployment script on EC2
                    bat '''
                    ssh -o StrictHostKeyChecking=no -i ${PEM_FILE_PATH} ${EC2_USER}@${EC2_HOST} << EOF
                    sudo systemctl stop maven-web-app
                    sudo cp /home/${EC2_USER}/01-maven-web-app.war 
                    sudo systemctl start maven-web-app
                    EOF
                    '''
                }
            }
        }
    }
}
